<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ãŠç¥­ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#ff3b5c">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
:root{
  --bg1:#12091f; --bg2:#2a0f3c;
  --gold:#ffd56a; --red:#ff3b5c; --blue:#3aa6ff;
  --panel:#1b1230cc; --text:#fff7e6;
}
body{
  margin:0; min-height:100vh; color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  display:flex; justify-content:center;
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(255,213,106,.25), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(58,166,255,.20), transparent 55%),
    linear-gradient(160deg,var(--bg1),var(--bg2));
}
.screen{display:none;width:100%;max-width:520px;padding:20px;text-align:center;box-sizing:border-box}
.active{display:block}

.panel{
  background:var(--panel);
  border:3px solid rgba(255,213,106,.75);
  border-radius:22px;
  padding:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

textarea{
  width:100%; height:190px;
  background:rgba(0,0,0,.25); color:var(--text);
  border:2px solid rgba(255,213,106,.75);
  border-radius:14px;
  padding:12px; font-size:15px;
  box-sizing:border-box;
}

.btn{
  border:none; border-radius:999px;
  padding:14px 20px; font-size:16px;
  font-weight:900; cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}
.btn-start{background:linear-gradient(#ffe08a,#ffb84d); color:#1b1b1b}
.btn-spin{background:linear-gradient(#ff4d6d,#ff1f4a);color:#fff;width:100%;max-width:320px}
.btn-back{
  position:fixed; right:16px; bottom:16px;
  background:rgba(255,255,255,.15); color:#fff;
  border:1px solid rgba(255,213,106,.7); font-size:12px;
}
.row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
.hint{font-size:12px;opacity:.8;margin-top:8px}

/* æç¯ */
.lanterns{
  position:fixed; top:0; left:0; right:0;
  display:flex; justify-content:space-around;
  padding:10px 0; pointer-events:none;
  z-index:5;
}
.lantern{
  width:22px; height:30px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #fff, var(--red));
  box-shadow:0 0 15px rgba(255,59,92,.8);
  animation:sway 2.8s ease-in-out infinite alternate;
}
.lantern:nth-child(odd){
  background:radial-gradient(circle at 30% 30%, #fff, var(--gold));
  box-shadow:0 0 15px rgba(255,213,106,.8);
}
@keyframes sway{from{transform:rotate(-3deg)}to{transform:rotate(3deg)}}

#canvas{
  width:100%; max-width:460px;
  border-radius:999px;
  box-shadow:
    0 0 0 6px rgba(255,213,106,.75),
    0 0 0 12px rgba(255,59,92,.28),
    0 20px 40px rgba(0,0,0,.5);
  background:rgba(0,0,0,.08);
}

#result{
  font-size:34px; font-weight:900;
  color:var(--gold); margin:12px 0;
  min-height:44px; line-height:1.15;
  text-shadow:0 10px 25px rgba(0,0,0,.55);
}

/* ãŠç¥è¼¿ï¼ˆå½“ãŸã‚Šæ¼”å‡ºï¼‰ */
#miko{
  position:fixed; left:50%; bottom:-240px;
  transform:translateX(-50%);
  font-size:120px;
  pointer-events:none;
  z-index:30;
  filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
}
.miko-show{ animation:miko 2.2s ease-out forwards; }
@keyframes miko{
  0%{bottom:-240px}
  30%{bottom:120px}
  60%{bottom:90px}
  100%{bottom:-240px}
}

/* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã“ã“ã«å‡ºã™ï¼‰ */
#debug{
  position:fixed;
  left:12px; right:12px; bottom:12px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,213,106,.5);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  font-size:12px;
  line-height:1.4;
  display:none;
  z-index:100;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
</style>
</head>

<body>

<!-- æç¯ -->
<div class="lanterns">
  <div class="lantern"></div><div class="lantern"></div><div class="lantern"></div>
  <div class="lantern"></div><div class="lantern"></div><div class="lantern"></div>
</div>

<!-- è¨­å®š -->
<div id="admin" class="screen active">
  <div class="panel">
    <h2 style="margin:6px 0 6px;">ğŸ® ãŠç¥­ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>
    <div class="hint">æœ€åˆã«ã€ŒéŸ³ONã€ã‚’æŠ¼ã™ã¨å¤ªé¼“ãŒé³´ã‚Šã¾ã™ï¼ˆiPhoneå¯¾ç­–ï¼‰</div>

    <textarea id="itemsInput">ã‚¢ãƒã‚®ãƒ•â‘ ,1/5000
ã‚¢ãƒã‚®ãƒ•â‘¡,1.5/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000</textarea>

    <div class="row">
      <button class="btn btn-start" onclick="enableSound()">ğŸ”Š éŸ³ON</button>
      <button class="btn btn-start" onclick="start()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
    </div>
    <div class="hint">å½¢å¼ï¼šæ™¯å“å,é‡ã¿ï¼ˆåˆ†æ•°OKï¼‰ï¼åŒåã‚’å¢—ã‚„ã™ã¨æ ã‚‚ç¢ºç‡ã‚‚åˆç®—</div>
  </div>
</div>

<!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ -->
<div id="game" class="screen">
  <div id="result">Tap to Spin!</div>
  <canvas id="canvas" width="500" height="500"></canvas>
  <div class="hint">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã§ã‚‚å›ã›ã¾ã™</div>

  <div style="margin-top:14px;">
    <button class="btn btn-spin" onclick="spin()">ğŸ¥ ãƒ‰ãƒ³ï¼</button>
  </div>

  <button class="btn btn-back" onclick="back()">è¨­å®šã¸</button>
</div>

<!-- ãŠç¥è¼¿ -->
<div id="miko">ğŸ®â›©ï¸ğŸ®</div>

<!-- ãƒ‡ãƒãƒƒã‚° -->
<div id="debug"></div>

<script>
(() => {
  const admin = document.getElementById("admin");
  const game = document.getElementById("game");
  const itemsInput = document.getElementById("itemsInput");
  const resultEl = document.getElementById("result");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const miko = document.getElementById("miko");
  const debug = document.getElementById("debug");

  const LS = "fes_items_v2";

  let items = []; // [{name, weight}]
  let angle = 0;
  let spinning = false;

  // ---- ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º ----
  function showDebug(msg){
    debug.style.display = "block";
    debug.textContent = msg;
  }
  window.addEventListener("error", (e) => {
    showDebug("JSã‚¨ãƒ©ãƒ¼: " + (e.message || "unknown") + (e.filename ? (" @ " + e.filename + ":" + e.lineno) : ""));
  });

  // ---- iPhoneå‘ã‘ï¼šéŸ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§è§£æ”¾ ----
  let actx = null;
  function getAudioCtx(){
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return null;
    if (!actx) actx = new AudioCtx();
    return actx;
  }

  window.enableSound = async function enableSound(){
    try{
      const c = getAudioCtx();
      if(!c) return alert("ã“ã®ç«¯æœ«ã¯éŸ³ç”Ÿæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
      if (c.state === "suspended") await c.resume();
      // ãƒ†ã‚¹ãƒˆã§å°ã•ãé³´ã‚‰ã™
      taiko(0.15);
      alert("éŸ³ONã«ã—ã¾ã—ãŸï¼ˆå¤ªé¼“OKï¼‰");
    }catch(err){
      showDebug("éŸ³ONå¤±æ•—: " + err);
      alert("éŸ³ãŒæœ‰åŠ¹åŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Safariã®è¨­å®š/æ¶ˆéŸ³/ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  }

  function taiko(gain=0.9){
    const c = getAudioCtx();
    if(!c || c.state !== "running") return; // éŸ³ONã—ã¦ãªã„ã¨é³´ã‚‰ã•ãªã„
    const o = c.createOscillator();
    const g = c.createGain();

    o.type = "sine";
    o.frequency.setValueAtTime(120, c.currentTime);
    o.frequency.exponentialRampToValueAtTime(70, c.currentTime + 0.12);

    g.gain.setValueAtTime(gain, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.45);

    o.connect(g).connect(c.destination);
    o.start();
    o.stop(c.currentTime + 0.5);
  }

  // ---- é‡ã¿ï¼ˆåˆ†æ•°OKï¼‰ ----
  function parseWeight(raw){
    const s = (raw ?? "").trim();
    if(!s) return 1;
    if(s.includes("/")){
      const [a,b] = s.split("/").map(x => Number(x.trim()));
      if(Number.isFinite(a) && Number.isFinite(b) && b > 0) return a / b;
    }
    const n = Number(s);
    if(Number.isFinite(n) && n > 0) return n;
    return 1;
  }

  function parseItems(){
    const lines = itemsInput.value
      .split("\n")
      .map(v => v.trim())
      .filter(Boolean);

    items = lines.map(line => {
      const [nameRaw, wRaw] = line.split(",");
      return { name: (nameRaw || "").trim() || "ï¼ˆç„¡åï¼‰", weight: parseWeight(wRaw) };
    });
  }

  function totalWeight(){
    return items.reduce((s,it)=>s+it.weight,0);
  }

  function pickWinnerIndex(){
    const t = totalWeight();
    let r = Math.random() * t;
    for(let i=0;i<items.length;i++){
      r -= items[i].weight;
      if(r <= 0) return i;
    }
    return items.length - 1;
  }

  // ---- æç”» ----
  function draw(){
    if(items.length === 0) return;

    const r = 230, cx = 250, cy = 250;
    const arc = 2 * Math.PI / items.length;

    ctx.clearRect(0,0,500,500);

    const colors = ["#ff3b5c","#ffd56a","#3aa6ff","#ff7a3d","#8b5cf6","#22c55e"];

    // å¤–æ ï¼ˆå¤ªã„é‡‘ç¸ï¼‰
    ctx.beginPath();
    ctx.arc(cx, cy, r + 8, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(0,0,0,.10)";
    ctx.fill();

    items.forEach((it,i)=>{
      const a0 = angle + i*arc;
      const a1 = angle + (i+1)*arc;

      ctx.beginPath();
      ctx.fillStyle = colors[i % colors.length];
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1);
      ctx.closePath();
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,.35)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(a0 + arc/2);
      ctx.textAlign = "right";
      ctx.font = "900 18px sans-serif";
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.strokeText(it.name, r - 22, 8);
      ctx.fillStyle = "#fff";
      ctx.fillText(it.name, r - 22, 8);
      ctx.restore();
    });

    // ä¸­å¤®
    ctx.beginPath();
    ctx.arc(cx,cy,44,0,Math.PI*2);
    ctx.fillStyle="rgba(0,0,0,.25)";
    ctx.fill();
    ctx.beginPath();
    ctx.arc(cx,cy,38,0,Math.PI*2);
    ctx.fillStyle="rgba(255,213,106,.95)";
    ctx.fill();
    ctx.fillStyle="#1b1b1b";
    ctx.font="900 16px sans-serif";
    ctx.textAlign="center";
    ctx.fillText("ç¥­", cx, cy+6);

    // ãƒã‚¤ãƒ³ã‚¿ï¼ˆå³ï¼‰
    ctx.fillStyle="#111";
    ctx.beginPath();
    ctx.moveTo(494,250); ctx.lineTo(458,226); ctx.lineTo(458,274);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle="rgba(255,213,106,.9)";
    ctx.lineWidth=3;
    ctx.stroke();
  }

  // ---- ç”»é¢æ“ä½œ ----
  function save(){
    localStorage.setItem(LS, itemsInput.value);
  }
  function load(){
    const v = localStorage.getItem(LS);
    if(v && v.trim()) itemsInput.value = v;
  }

  window.start = function start(){
    try{
      save();
      parseItems();
      if(items.length === 0) return alert("é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“");
      admin.classList.remove("active");
      game.classList.add("active");
      resultEl.textContent = "Tap to Spin!";
      draw();
    }catch(err){
      showDebug("startå¤±æ•—: " + err);
    }
  }

  window.back = function back(){
    game.classList.remove("active");
    admin.classList.add("active");
  }

  window.spin = function spin(){
    try{
      if(spinning) return;
      if(items.length === 0) parseItems();
      if(items.length === 0) return;

      spinning = true;

      // éŸ³ï¼ˆONæ¸ˆã¿ãªã‚‰é³´ã‚‹ï¼‰
      taiko(0.95);

      const win = pickWinnerIndex();
      const arc = 2 * Math.PI / items.length;
      const mid = win*arc + arc/2;

      const two = 2*Math.PI;
      const targetBase = ((-mid % two) + two) % two;
      const currentNorm = ((angle % two) + two) % two;

      let delta = (targetBase - currentNorm + two) % two;
      delta += (5 + Math.floor(Math.random()*3)) * two;

      const startA = angle;
      const endA = angle + delta;
      const st = performance.now();
      const duration = 2600 + Math.random()*700;

      function easeOutCubic(p){ return 1 - Math.pow(1-p, 3); }

      resultEl.textContent = "æŠ½é¸ä¸­â€¦";

      function anim(now){
        const p = Math.min(1, (now - st) / duration);
        angle = startA + (endA - startA) * easeOutCubic(p);
        draw();
        if(p < 1) requestAnimationFrame(anim);
        else{
          spinning = false;
          const name = items[win].name;
          resultEl.textContent = "ğŸŠ " + name + " ğŸŠ";

          // å½“ãŸã‚Šï¼ˆæ®‹å¿µä»¥å¤–ï¼‰ã§ãŠç¥è¼¿
          if(!name.includes("æ®‹å¿µ")){
            miko.classList.remove("miko-show");
            void miko.offsetWidth; // reflow
            miko.classList.add("miko-show");
          }
        }
      }
      requestAnimationFrame(anim);

    }catch(err){
      showDebug("spinå¤±æ•—: " + err);
      spinning = false;
    }
  }

  canvas.addEventListener("click", () => window.spin());

  // åˆå›å¾©å…ƒ
  load();

  // ã‚‚ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒæç”»ã•ã‚Œãªã„å ´åˆã®ä¿é™º
  try{
    parseItems();
    if(items.length > 0) draw();
  }catch(err){
    showDebug("åˆæœŸæç”»å¤±æ•—: " + err);
  }
})();
</script>

<!-- PWA -->
<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>navigator.serviceWorker.register("./sw.js"));
}
</script>

</body>
</html>
