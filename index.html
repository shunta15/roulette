<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ãŠç¥­ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#ff3b5c">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
:root{
  --bg1:#12091f; --bg2:#2a0f3c;
  --gold:#ffd56a; --red:#ff3b5c; --blue:#3aa6ff;
  --panel:#1b1230cc; --text:#fff7e6;
}
body{
  margin:0; min-height:100vh; color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  display:flex; justify-content:center;
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(255,213,106,.25), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(58,166,255,.20), transparent 55%),
    linear-gradient(160deg,var(--bg1),var(--bg2));
}
.screen{display:none;width:100%;max-width:520px;padding:20px;text-align:center}
.active{display:block}

.panel{
  background:var(--panel); border:3px solid var(--gold);
  border-radius:22px; padding:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.4)
}

textarea{
  width:100%; height:180px;
  background:rgba(0,0,0,.25); color:var(--text);
  border:2px solid var(--gold); border-radius:14px;
  padding:12px; font-size:15px;
}

.btn{
  border:none; border-radius:999px;
  padding:14px 32px; font-size:18px;
  font-weight:900; cursor:pointer;
}
.btn-start{background:linear-gradient(#ffe08a,#ffb84d)}
.btn-spin{background:linear-gradient(#ff4d6d,#ff1f4a);color:#fff;width:100%}
.btn-back{
  position:fixed; right:16px; bottom:16px;
  background:rgba(255,255,255,.15); color:#fff;
  border:1px solid var(--gold); font-size:12px;
}

/* æç¯ */
.lanterns{
  position:fixed; top:0; left:0; right:0;
  display:flex; justify-content:space-around;
  padding:10px 0; pointer-events:none;
}
.lantern{
  width:22px; height:30px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #fff, var(--red));
  box-shadow:0 0 15px rgba(255,59,92,.8);
  animation:sway 2.8s ease-in-out infinite alternate;
}
.lantern:nth-child(odd){background:radial-gradient(circle at 30% 30%, #fff, var(--gold))}
@keyframes sway{from{transform:rotate(-3deg)}to{transform:rotate(3deg)}}

#canvas{
  width:100%; max-width:460px;
  border-radius:999px;
  box-shadow:
    0 0 0 6px var(--gold),
    0 0 0 12px rgba(255,59,92,.3),
    0 20px 40px rgba(0,0,0,.5);
}

#result{
  font-size:34px; font-weight:900;
  color:var(--gold); margin:12px 0;
}

/* ãŠç¥è¼¿ï¼ˆå½“ãŸã‚Šæ¼”å‡ºï¼‰ */
#miko{
  position:fixed; left:50%; bottom:-200px;
  transform:translateX(-50%);
  font-size:120px; pointer-events:none;
}
.miko-show{
  animation:miko 2.2s ease-out forwards;
}
@keyframes miko{
  0%{bottom:-200px}
  30%{bottom:120px}
  60%{bottom:90px}
  100%{bottom:-200px}
}
</style>
</head>

<body>

<!-- æç¯ -->
<div class="lanterns">
  <div class="lantern"></div><div class="lantern"></div><div class="lantern"></div>
  <div class="lantern"></div><div class="lantern"></div><div class="lantern"></div>
</div>

<!-- è¨­å®š -->
<div id="admin" class="screen active">
  <div class="panel">
    <h2>ğŸ® ãŠç¥­ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>
    <textarea id="itemsInput">ã‚¢ãƒã‚®ãƒ•â‘ ,1/5000
ã‚¢ãƒã‚®ãƒ•â‘¡,1.5/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000</textarea>
    <button class="btn btn-start" onclick="start()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
  </div>
</div>

<!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ -->
<div id="game" class="screen">
  <div id="result">Tap to Spin!</div>
  <canvas id="canvas" width="500" height="500"></canvas>
  <button class="btn btn-spin" onclick="spin()">ãƒ‰ãƒ³ï¼</button>
  <button class="btn btn-back" onclick="back()">è¨­å®šã¸</button>
</div>

<!-- ãŠç¥è¼¿ -->
<div id="miko">â›©ï¸</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let items=[], angle=0, spinning=false;
const LS="fes_items";

/* ==== å¤ªé¼“éŸ³ï¼ˆWeb Audioï¼‰ ==== */
const AudioCtx = window.AudioContext||window.webkitAudioContext;
const actx = new AudioCtx();
function taiko(){
  const o = actx.createOscillator();
  const g = actx.createGain();
  o.type="sine"; o.frequency.value=90;
  g.gain.setValueAtTime(1,actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.5);
  o.connect(g).connect(actx.destination);
  o.start(); o.stop(actx.currentTime+0.5);
}

/* ==== æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ ==== */
function w(raw){
  if(raw.includes("/")){
    const[a,b]=raw.split("/").map(Number);
    return a/b;
  }
  return Number(raw)||1;
}
function parse(){
  items=document.getElementById("itemsInput").value
    .split("\n").filter(Boolean)
    .map(l=>{
      const[n,r]=l.split(",");
      return{name:n,weight:w(r||"1")};
    });
}
function pick(){
  const t=items.reduce((s,i)=>s+i.weight,0);
  let r=Math.random()*t;
  for(let i=0;i<items.length;i++){
    r-=items[i].weight;
    if(r<=0)return i;
  }
  return items.length-1;
}

/* ==== æç”» ==== */
function draw(){
  const r=230,cx=250,cy=250;
  const arc=2*Math.PI/items.length;
  ctx.clearRect(0,0,500,500);
  const colors=["#ff3b5c","#ffd56a","#3aa6ff","#ff7a3d","#22c55e"];
  items.forEach((it,i)=>{
    ctx.beginPath();
    ctx.fillStyle=colors[i%colors.length];
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,angle+i*arc,angle+(i+1)*arc);
    ctx.fill();
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle+i*arc+arc/2);
    ctx.fillStyle="#fff";
    ctx.font="900 18px sans-serif";
    ctx.textAlign="right";
    ctx.fillText(it.name,r-20,8);
    ctx.restore();
  });
  ctx.fillStyle="#111";
  ctx.beginPath();
  ctx.moveTo(494,250); ctx.lineTo(458,226); ctx.lineTo(458,274);
  ctx.fill();
}

/* ==== æ“ä½œ ==== */
function start(){
  parse(); localStorage.setItem(LS,itemsInput.value);
  admin.classList.remove("active");
  game.classList.add("active");
  draw();
}
function back(){
  game.classList.remove("active");
  admin.classList.add("active");
}
function spin(){
  if(spinning)return;
  spinning=true; taiko();
  const win=pick();
  const arc=2*Math.PI/items.length;
  const mid=win*arc+arc/2;
  const two=2*Math.PI;
  let delta=(((-mid-angle)%two)+two)%two + two*5;
  const start=angle, end=angle+delta;
  const st=performance.now();
  function anim(t){
    const p=Math.min(1,(t-st)/2600);
    angle=start+(end-start)*(1-Math.pow(1-p,3));
    draw();
    if(p<1)requestAnimationFrame(anim);
    else{
      spinning=false;
      result.textContent="ğŸŠ "+items[win].name+" ğŸŠ";
      if(!items[win].name.includes("æ®‹å¿µ")){
        miko.classList.add("miko-show");
        setTimeout(()=>miko.classList.remove("miko-show"),2200);
      }
    }
  }
  requestAnimationFrame(anim);
}
canvas.onclick=spin;

/* åˆæœŸå¾©å…ƒ */
const saved=localStorage.getItem(LS);
if(saved) itemsInput.value=saved;
</script>

<script>
if("serviceWorker"in navigator){
  window.addEventListener("load",()=>navigator.serviceWorker.register("./sw.js"));
}
</script>

</body>
</html>
