<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>

  <!-- ===== PWA è¿½åŠ  ===== -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#ff9f43">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <!-- ==================== -->

  <style>
    :root{
      --bg-color:#fff9f0;
      --panel-color:#ffffff;
      --accent-color:#ff6b6b;
      --text-color:#333;
    }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Segoe UI", sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      overflow-x:hidden;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .screen{display:none;width:100%;max-width:520px;padding:20px;box-sizing:border-box;text-align:center;}
    .active{display:block;animation:fadeIn .25s;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .admin-panel{
      background:var(--panel-color);
      padding:25px;
      border-radius:25px;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      border:2px solid #ffda79;
    }

    textarea{
      width:100%;
      height:180px;
      border:2px solid #ffda79;
      border-radius:12px;
      padding:12px;
      font-size:16px;
      box-sizing:border-box;
      outline:none;
      margin:10px 0;
      resize:vertical;
    }

    #canvas{
      width:100%;
      max-width:460px;
      height:auto;
      filter:drop-shadow(0 8px 20px rgba(0,0,0,.1));
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    #result{
      font-size:36px;
      font-weight:900;
      margin:18px 0 10px;
      color:#ff4757;
      min-height:52px;
      line-height: 1.2;
    }

    .hint{font-size:12px;opacity:.7;margin-top:6px;}

    .btn{
      cursor:pointer;border:none;border-radius:50px;font-weight:bold;
      padding:15px 40px;font-size:20px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary{background:#ff9f43;color:#fff;}
    .btn-spin{background:#ff4757;color:#fff;width:100%;max-width:260px;}
    .btn-secondary{
      background:#ced4da;color:#495057;
      position:fixed;bottom:20px;right:20px;
      font-size:12px;padding:8px 15px;border-radius:999px;
    }

    .note{
      font-size:12px;
      opacity:.75;
      line-height:1.5;
      text-align:left;
      margin-top:10px;
    }
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px;}
    .row .btn{font-size:14px;padding:10px 14px;border-radius:14px;}
  </style>
</head>

<body>

  <!-- è¨­å®šç”»é¢ -->
  <div id="adminScreen" class="screen active">
    <div class="admin-panel">
      <h2>âš™ï¸ è¨­å®š</h2>

      <!-- å…¥åŠ›å½¢å¼ï¼šæ™¯å“å,é‡ã¿ï¼ˆå°æ•°OK / åˆ†æ•°OK ä¾‹: 1/5000ï¼‰ -->
      <textarea id="itemsInput">ã‚¢ãƒã‚®ãƒ•â‘ ,1/5000
ã‚¢ãƒã‚®ãƒ•â‘¡,1.5/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000</textarea>

      <div class="row">
        <button class="btn btn-primary" onclick="start()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
        <button class="btn" style="background:#f1f3f5;color:#333;border:1px solid rgba(0,0,0,.08);" onclick="resetItems()">åˆæœŸåŒ–</button>
      </div>

      <div class="note">
        ãƒ»å½¢å¼ï¼š<b>æ™¯å“å,é‡ã¿</b>ï¼ˆä¾‹ï¼šç‰¹è³,1 / å½“ãŸã‚Š,5 / æ®‹å¿µ,10ï¼‰<br>
        ãƒ»<b>åˆ†æ•°</b>ã‚‚OKï¼ˆä¾‹ï¼š1/5000ï¼‰<br>
        ãƒ»åŒã˜æ™¯å“ã‚’<b>è¤‡æ•°è¡Œ</b>ã«ã™ã‚‹ã¨ã€ãã®åˆ†<b>è¦‹ãŸç›®ã®æ ã‚‚å¢—ãˆ</b>ã€<b>ç¢ºç‡ã‚‚åˆç®—</b>ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”»é¢ -->
  <div id="rouletteScreen" class="screen">
    <div id="result">Tap to Spin!</div>
    <canvas id="canvas" width="500" height="500"></canvas>
    <div class="hint">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã§ã‚‚å›ã›ã¾ã™</div>

    <div style="margin-top:18px;">
      <button class="btn btn-spin" onclick="spin()">SPIN</button>
    </div>

    <button class="btn btn-secondary" onclick="back()">è¨­å®šã¸</button>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let items = []; // [{name, weight}]
    let angle = 0;
    let spinning = false;

    const LS_KEY = "roulette_items_text_v1";

    function defaultItemsText(){
      return `ã‚¢ãƒã‚®ãƒ•â‘ ,1/5000
ã‚¢ãƒã‚®ãƒ•â‘¡,1.5/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000`;
    }

    function saveItemsText(){
      localStorage.setItem(LS_KEY, document.getElementById("itemsInput").value);
    }

    function loadItemsText(){
      const v = localStorage.getItem(LS_KEY);
      if (v && v.trim()) document.getElementById("itemsInput").value = v;
    }

    function resetItems(){
      if(!confirm("è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) return;
      document.getElementById("itemsInput").value = defaultItemsText();
      saveItemsText();
      alert("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    }

    // "1/5000" ã‚„ "0.2" ã‚’æ•°å€¤ã«ã™ã‚‹
    function parseWeight(raw) {
      const s = (raw ?? "").trim();
      if (!s) return 1;

      // åˆ†æ•° "a/b"
      if (s.includes("/")) {
        const [a, b] = s.split("/").map(x => Number(x.trim()));
        if (Number.isFinite(a) && Number.isFinite(b) && b > 0) return a / b;
      }

      // å°æ•°/æ•´æ•°
      const n = Number(s);
      if (Number.isFinite(n) && n > 0) return n;

      return 1;
    }

    function parseItems() {
      const lines = document.getElementById("itemsInput").value
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);

      items = lines.map(line => {
        const [nameRaw, weightRaw] = line.split(",");
        const name = (nameRaw || "").trim() || "ï¼ˆç„¡åï¼‰";
        const weight = parseWeight(weightRaw);
        return { name, weight };
      });
    }

    function totalWeight() {
      return items.reduce((sum, it) => sum + it.weight, 0);
    }

    // é‡ã¿ä»˜ã‘æŠ½é¸ï¼ˆå½“é¸indexï¼‰
    function pickWinnerIndex() {
      const t = totalWeight();
      let r = Math.random() * t;
      for (let i = 0; i < items.length; i++) {
        r -= items[i].weight;
        if (r <= 0) return i;
      }
      return items.length - 1;
    }

    function start(){
      saveItemsText();
      parseItems();
      if (items.length === 0) return alert("é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“");

      document.getElementById("adminScreen").classList.remove("active");
      document.getElementById("rouletteScreen").classList.add("active");
      document.getElementById("result").innerText = "Tap to Spin!";
      draw();
    }

    function back(){
      document.getElementById("rouletteScreen").classList.remove("active");
      document.getElementById("adminScreen").classList.add("active");
    }

    function draw(){
      if (items.length === 0) return;

      const r = 230;
      const cx = 250, cy = 250;

      // è¦‹ãŸç›®ã¯ç­‰åˆ†ï¼ˆæ æ•°ã‚’å¢—ã‚„ã—ãŸã‘ã‚Œã°åŒåè¡Œã‚’å¢—ã‚„ã™ï¼‰
      const arc = 2 * Math.PI / items.length;

      ctx.clearRect(0,0,500,500);

      items.forEach((it, i) => {
        ctx.beginPath();
        ctx.fillStyle = `hsl(${i*360/items.length},80%,65%)`;
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, angle + i*arc, angle + (i+1)*arc);
        ctx.fill();

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle + i*arc + arc/2);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 18px sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(it.name, r - 20, 8);
        ctx.restore();
      });

      // ãƒã‚¤ãƒ³ã‚¿ï¼ˆå³ï¼‰
      ctx.fillStyle = "#333";
      ctx.beginPath();
      ctx.moveTo(490, 250);
      ctx.lineTo(460, 230);
      ctx.lineTo(460, 270);
      ctx.fill();
    }

    // å½“é¸æ ã®ä¸­å¤®ã§æ­¢ã‚ã‚‹
    function spin(){
      if (spinning) return;
      if (items.length === 0) parseItems();
      if (items.length === 0) return;

      spinning = true;

      const winner = pickWinnerIndex();
      const arc = 2 * Math.PI / items.length;
      const mid = winner * arc + arc/2;

      const twoPi = 2 * Math.PI;
      const targetBase = ((-mid % twoPi) + twoPi) % twoPi;
      const currentNorm = ((angle % twoPi) + twoPi) % twoPi;

      let delta = (targetBase - currentNorm + twoPi) % twoPi;
      delta += (5 + Math.floor(Math.random()*3)) * twoPi; // 5ã€œ7å›è»¢

      const startAngle = angle;
      const endAngle = angle + delta;
      const duration = 2600 + Math.random()*700;
      const st = performance.now();

      function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      document.getElementById("result").innerText = "æŠ½é¸ä¸­â€¦";

      function anim(now){
        const p = Math.min(1, (now - st) / duration);
        const e = easeOutCubic(p);
        angle = startAngle + (endAngle - startAngle) * e;
        draw();

        if (p < 1) requestAnimationFrame(anim);
        else {
          spinning = false;
          document.getElementById("result").innerText = "ğŸŠ " + items[winner].name + " ğŸŠ";
        }
      }

      requestAnimationFrame(anim);
    }

    // ã‚¿ãƒƒãƒ—ã§ã‚‚å›ã›ã‚‹
    canvas.addEventListener("click", spin);

    // åˆå›ï¼šä¿å­˜æ¸ˆã¿è¨­å®šã‚’å¾©å…ƒ
    loadItemsText();
  </script>

  <!-- ===== Service Worker ç™»éŒ²ï¼ˆPWAï¼‰===== -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
  <!-- =================================== -->

</body>
</html>
