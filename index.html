<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>オフライン・ルーレット</title>

  <!-- ===== PWA 追加 ===== -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#ff9f43">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ルーレット">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <!-- ==================== -->

  <style>
    :root{
      --bg-color:#fff9f0;
      --panel-color:#ffffff;
      --accent-color:#ff6b6b;
      --text-color:#333;
    }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Segoe UI", sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      overflow-x:hidden;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .screen{display:none;width:100%;max-width:520px;padding:20px;box-sizing:border-box;text-align:center;}
    .active{display:block;animation:fadeIn .25s;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .admin-panel{
      background:var(--panel-color);
      padding:25px;
      border-radius:25px;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      border:2px solid #ffda79;
    }

    textarea{
      width:100%;
      height:140px;
      border:2px solid #ffda79;
      border-radius:12px;
      padding:12px;
      font-size:16px;
      box-sizing:border-box;
      outline:none;
      margin:10px 0;
      resize:vertical;
    }

    #canvas{
      width:100%;
      max-width:460px;
      height:auto;
      filter:drop-shadow(0 8px 20px rgba(0,0,0,.1));
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    #result{
      font-size:36px;
      font-weight:900;
      margin:18px 0 10px;
      color:#ff4757;
      min-height:52px;
    }

    .btn{
      cursor:pointer;border:none;border-radius:50px;font-weight:bold;
      padding:15px 40px;font-size:20px;
    }
    .btn-primary{background:#ff9f43;color:#fff;}
    .btn-spin{background:#ff4757;color:#fff;width:100%;max-width:260px;}
    .btn-secondary{
      background:#ced4da;color:#495057;
      position:fixed;bottom:20px;right:20px;
      font-size:12px;padding:8px 15px;border-radius:999px;
    }
  </style>
</head>

<body>

  <!-- 設定画面 -->
  <div id="adminScreen" class="screen active">
    <div class="admin-panel">
      <h2>⚙️ 設定</h2>
      <textarea id="itemsInput">特賞,1
当たり,5
残念,10
残念,10</textarea>
      <button class="btn btn-primary" onclick="start()">ルーレット開始</button>
    </div>
  </div>

  <!-- ルーレット画面 -->
  <div id="rouletteScreen" class="screen">
    <div id="result">Tap to Spin!</div>
    <canvas id="canvas" width="500" height="500"></canvas>
    <button class="btn btn-spin" onclick="spin()">SPIN</button>
    <button class="btn btn-secondary" onclick="back()">設定へ</button>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let items = [];
    let angle = 0;
    let spinning = false;

    function start(){
      items = document.getElementById("itemsInput").value
        .split("\n")
        .map(v => v.split(",")[0]);
      document.getElementById("adminScreen").classList.remove("active");
      document.getElementById("rouletteScreen").classList.add("active");
      draw();
    }

    function back(){
      document.getElementById("rouletteScreen").classList.remove("active");
      document.getElementById("adminScreen").classList.add("active");
    }

    function draw(){
      const r = 230;
      const cx = 250, cy = 250;
      const arc = 2 * Math.PI / items.length;
      ctx.clearRect(0,0,500,500);

      items.forEach((item,i)=>{
        ctx.beginPath();
        ctx.fillStyle = `hsl(${i*360/items.length},80%,65%)`;
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,angle+i*arc,angle+(i+1)*arc);
        ctx.fill();

        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(angle+i*arc+arc/2);
        ctx.fillStyle="#fff";
        ctx.font="bold 18px sans-serif";
        ctx.textAlign="right";
        ctx.fillText(item,r-20,8);
        ctx.restore();
      });

      ctx.fillStyle="#333";
      ctx.beginPath();
      ctx.moveTo(490,250);
      ctx.lineTo(460,230);
      ctx.lineTo(460,270);
      ctx.fill();
    }

    function spin(){
      if(spinning) return;
      spinning=true;
      const target = Math.random()*Math.PI*2 + Math.PI*6;
      const start = angle;
      const duration = 2500;
      const st = performance.now();

      function anim(t){
        const p = Math.min(1,(t-st)/duration);
        angle = start + target*p;
        draw();
        if(p<1) requestAnimationFrame(anim);
        else spinning=false;
      }
      requestAnimationFrame(anim);
    }
  </script>

  <!-- ===== Service Worker 登録（PWA）===== -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
  <!-- =================================== -->

</body>
</html>
