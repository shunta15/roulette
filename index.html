<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ãŠç¥­ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰</title>

  <!-- ===== PWA è¿½åŠ  ===== -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#ff3b5c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <!-- ==================== -->

  <style>
    :root{
      --bg1:#12091f;        /* å¤œç©º */
      --bg2:#2a0f3c;        /* ç´« */
      --panel:#1b1230cc;    /* åŠé€æ˜ãƒ‘ãƒãƒ« */
      --gold:#ffd56a;       /* é‡‘ */
      --red:#ff3b5c;        /* æœ± */
      --blue:#3aa6ff;       /* ç¥­ã‚Šé’ */
      --text:#fff7e6;
      --ink:#1b1b1b;
    }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Segoe UI", sans-serif;
      margin:0;
      min-height:100vh;
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      overflow-x:hidden;
      padding-bottom: env(safe-area-inset-bottom);

      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,213,106,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(58,166,255,.20), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(255,59,92,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }

    /* æç¯ã¿ãŸã„ãªä¸Šã®é£¾ã‚Š */
    body::before{
      content:"";
      position:fixed;
      left:0; right:0; top:0;
      height:110px;
      pointer-events:none;
      background:
        radial-gradient(circle at 7% 60%, rgba(255,59,92,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 14% 60%, rgba(255,213,106,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 21% 60%, rgba(58,166,255,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 28% 60%, rgba(255,59,92,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 35% 60%, rgba(255,213,106,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 42% 60%, rgba(58,166,255,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 49% 60%, rgba(255,59,92,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 56% 60%, rgba(255,213,106,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 63% 60%, rgba(58,166,255,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 70% 60%, rgba(255,59,92,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 77% 60%, rgba(255,213,106,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 84% 60%, rgba(58,166,255,.95) 0 18px, rgba(0,0,0,0) 19px),
        radial-gradient(circle at 91% 60%, rgba(255,59,92,.95) 0 18px, rgba(0,0,0,0) 19px),
        linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      opacity:.95;
    }

    .screen{
      display:none;
      width:100%;
      max-width:520px;
      padding:22px 18px;
      box-sizing:border-box;
      text-align:center;
    }
    .active{display:block;animation:fadeIn .25s;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .admin-panel{
      background: var(--panel);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:22px;
      border-radius:22px;
      border: 3px solid rgba(255,213,106,.7);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .admin-panel::before{
      content:"";
      position:absolute; inset:-2px;
      border-radius:22px;
      padding:2px;
      background: linear-gradient(135deg, rgba(255,213,106,.9), rgba(255,59,92,.8), rgba(58,166,255,.7));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .title{
      margin: 4px 0 6px;
      font-size: 22px;
      letter-spacing: .08em;
      font-weight: 900;
      text-shadow: 0 6px 18px rgba(0,0,0,.45);
    }
    .sub{
      margin: 0 0 14px;
      font-size: 12px;
      opacity: .85;
      letter-spacing: .06em;
    }

    textarea{
      width:100%;
      height:200px;
      border: 2px solid rgba(255,213,106,.65);
      border-radius:14px;
      padding:12px 12px;
      font-size:15px;
      box-sizing:border-box;
      outline:none;
      margin:10px 0 6px;
      resize:vertical;
      color: var(--text);
      background: rgba(0,0,0,.22);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.15);
    }

    .note{
      font-size:12px;
      opacity:.85;
      line-height:1.6;
      text-align:left;
      margin-top:10px;
    }

    #canvas{
      width:100%;
      max-width:460px;
      height:auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      border-radius: 999px;
      box-shadow:
        0 18px 45px rgba(0,0,0,.45),
        0 0 0 6px rgba(255,213,106,.65),
        0 0 0 12px rgba(255,59,92,.25);
      background: rgba(0,0,0,.08);
    }

    #result{
      font-size: 34px;
      font-weight: 900;
      margin: 14px 0 10px;
      color: var(--gold);
      min-height: 52px;
      line-height: 1.15;
      text-shadow:
        0 10px 25px rgba(0,0,0,.55),
        0 0 22px rgba(255,213,106,.25);
    }

    .hint{font-size:12px;opacity:.8;margin-top:6px;letter-spacing:.04em;}

    .btn{
      cursor:pointer;
      border:none;
      border-radius: 999px;
      font-weight: 900;
      padding: 14px 34px;
      font-size: 18px;
      -webkit-tap-highlight-color: transparent;
      transition: transform .04s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }

    .btn-primary{
      color: var(--ink);
      background: linear-gradient(180deg, #ffe08a, #ffb84d);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }

    .btn-ghost{
      color: var(--text);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,213,106,.35);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .btn-spin{
      color: white;
      width:100%;
      max-width:280px;
      background: linear-gradient(180deg, #ff4d6d, #ff1f4a);
      box-shadow:
        0 18px 40px rgba(0,0,0,.45),
        0 0 0 4px rgba(255,213,106,.35);
    }

    .btn-secondary{
      background: rgba(255,255,255,.14);
      color: var(--text);
      position:fixed;bottom:18px;right:18px;
      font-size:12px;padding:9px 14px;border-radius:999px;
      border: 1px solid rgba(255,213,106,.4);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px;}
    .row .btn{font-size:14px;padding:10px 14px;border-radius:14px;}

    .badge{
      display:inline-block;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,213,106,.15);
      border: 1px solid rgba(255,213,106,.35);
      margin-top:8px;
      letter-spacing:.06em;
    }
  </style>
</head>

<body>

  <!-- è¨­å®šç”»é¢ -->
  <div id="adminScreen" class="screen active">
    <div class="admin-panel">
      <div class="title">ğŸ® ãŠç¥­ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</div>
      <div class="sub">ç¢ºç‡ï¼ˆåˆ†æ•°OKï¼‰ï¼æ®‹å¿µã‚’å¢—ã‚„ã™ã¨è¦‹ãŸç›®ã‚‚ç¢ºç‡ã‚‚åˆç®—</div>

      <textarea id="itemsInput">ã‚¢ãƒã‚®ãƒ•â‘ ,1/5000
ã‚¢ãƒã‚®ãƒ•â‘¡,1.5/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000</textarea>

      <div class="row">
        <button class="btn btn-primary" onclick="start()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
        <button class="btn btn-ghost" onclick="resetItems()">åˆæœŸåŒ–</button>
      </div>

      <div class="badge">å…¥åŠ›å½¢å¼ï¼šæ™¯å“å,é‡ã¿ï¼ˆä¾‹ï¼šå½“ãŸã‚Š,5 / 1/5000ï¼‰</div>

      <div class="note">
        ãƒ»åŒã˜æ™¯å“ã‚’è¤‡æ•°è¡Œã«ã™ã‚‹ã¨ <b>æ ãŒå¢—ãˆã‚‹</b> ï¼‹ <b>ç¢ºç‡ã‚‚åˆç®—</b> ã•ã‚Œã¾ã™ã€‚<br>
        ãƒ»ç¢ºç‡ã‚’å›ºå®šã—ãŸã„å ´åˆã¯ã€Œç·ç¢ºç‡ Ã· æ æ•°ã€ã‚’å„è¡Œã«å…¥ã‚Œã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”»é¢ -->
  <div id="rouletteScreen" class="screen">
    <div id="result">Tap to Spin!</div>
    <canvas id="canvas" width="500" height="500"></canvas>
    <div class="hint">ğŸ† ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã§ã‚‚å›ã›ã¾ã™</div>

    <div style="margin-top:18px;">
      <button class="btn btn-spin" onclick="spin()">SPIN</button>
    </div>

    <button class="btn btn-secondary" onclick="back()">è¨­å®šã¸</button>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let items = []; // [{name, weight}]
    let angle = 0;
    let spinning = false;

    const LS_KEY = "roulette_items_text_v1";

    function defaultItemsText(){
      return `ã‚¢ãƒã‚®ãƒ•â‘ ,1/5000
ã‚¢ãƒã‚®ãƒ•â‘¡,1.5/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000
æ®‹å¿µ,624.6875/5000`;
    }

    function saveItemsText(){
      localStorage.setItem(LS_KEY, document.getElementById("itemsInput").value);
    }

    function loadItemsText(){
      const v = localStorage.getItem(LS_KEY);
      if (v && v.trim()) document.getElementById("itemsInput").value = v;
    }

    function resetItems(){
      if(!confirm("è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) return;
      document.getElementById("itemsInput").value = defaultItemsText();
      saveItemsText();
      alert("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    }

    // "1/5000" ã‚„ "0.2" ã‚’æ•°å€¤ã«ã™ã‚‹
    function parseWeight(raw) {
      const s = (raw ?? "").trim();
      if (!s) return 1;

      // åˆ†æ•° "a/b"
      if (s.includes("/")) {
        const [a, b] = s.split("/").map(x => Number(x.trim()));
        if (Number.isFinite(a) && Number.isFinite(b) && b > 0) return a / b;
      }

      // å°æ•°/æ•´æ•°
      const n = Number(s);
      if (Number.isFinite(n) && n > 0) return n;

      return 1;
    }

    function parseItems() {
      const lines = document.getElementById("itemsInput").value
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);

      items = lines.map(line => {
        const [nameRaw, weightRaw] = line.split(",");
        const name = (nameRaw || "").trim() || "ï¼ˆç„¡åï¼‰";
        const weight = parseWeight(weightRaw);
        return { name, weight };
      });
    }

    function totalWeight() {
      return items.reduce((sum, it) => sum + it.weight, 0);
    }

    // é‡ã¿ä»˜ã‘æŠ½é¸ï¼ˆå½“é¸indexï¼‰
    function pickWinnerIndex() {
      const t = totalWeight();
      let r = Math.random() * t;
      for (let i = 0; i < items.length; i++) {
        r -= items[i].weight;
        if (r <= 0) return i;
      }
      return items.length - 1;
    }

    function start(){
      saveItemsText();
      parseItems();
      if (items.length === 0) return alert("é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“");

      document.getElementById("adminScreen").classList.remove("active");
      document.getElementById("rouletteScreen").classList.add("active");
      document.getElementById("result").innerText = "Tap to Spin!";
      draw();
    }

    function back(){
      document.getElementById("rouletteScreen").classList.remove("active");
      document.getElementById("adminScreen").classList.add("active");
    }

    function draw(){
      if (items.length === 0) return;

      const r = 230;
      const cx = 250, cy = 250;

      // è¦‹ãŸç›®ã¯ç­‰åˆ†ï¼ˆæ ã‚’å¢—ã‚„ã—ãŸã„å ´åˆã¯è¡Œã‚’å¢—ã‚„ã™ï¼‰
      const arc = 2 * Math.PI / items.length;
      ctx.clearRect(0,0,500,500);

      const colors = ["#ff3b5c","#ffd56a","#3aa6ff","#ff7a3d","#8b5cf6","#22c55e"];

      // å¤–æ ï¼ˆå¤ªã„é‡‘ç¸ï¼‰
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx, cy, r + 8, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(0,0,0,.10)";
      ctx.fill();
      ctx.restore();

      items.forEach((it, i) => {
        const startA = angle + i * arc;
        const endA = angle + (i + 1) * arc;

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
        ctx.beginPath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, startA, endA);
        ctx.closePath();
        ctx.fill();

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¢ƒç•Œç·š
        ctx.strokeStyle = "rgba(255,255,255,.35)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // ãƒ†ã‚­ã‚¹ãƒˆ
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(startA + arc / 2);
        ctx.fillStyle = "#fff";
        ctx.font = "900 18px sans-serif";
        ctx.textAlign = "right";
        // æ–‡å­—ã®ç¸å–ã‚Šï¼ˆçœ‹æ¿ã£ã½ãï¼‰
        ctx.lineWidth = 6;
        ctx.strokeStyle = "rgba(0,0,0,.35)";
        ctx.strokeText(it.name, r - 22, 8);
        ctx.fillText(it.name, r - 22, 8);
        ctx.restore();
      });

      // ä¸­å¤®ã®ä¸¸ï¼ˆå¤œåº—ã®éˆ´ã£ã½ã„ï¼‰
      ctx.beginPath();
      ctx.arc(cx, cy, 44, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, 38, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255,213,106,.95)";
      ctx.fill();

      ctx.fillStyle = "#1b1b1b";
      ctx.font = "900 16px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("ç¥­", cx, cy + 6);

      // ãƒã‚¤ãƒ³ã‚¿ï¼ˆå³ï¼‰
      ctx.fillStyle="#111";
      ctx.beginPath();
      ctx.moveTo(494, 250);
      ctx.lineTo(458, 226);
      ctx.lineTo(458, 274);
      ctx.closePath();
      ctx.fill();

      // ãƒã‚¤ãƒ³ã‚¿ã®ç¸ï¼ˆé‡‘ï¼‰
      ctx.strokeStyle="rgba(255,213,106,.9)";
      ctx.lineWidth=3;
      ctx.stroke();
    }

    // å½“é¸æ ã®ä¸­å¤®ã§æ­¢ã‚ã‚‹
    function spin(){
      if (spinning) return;
      if (items.length === 0) parseItems();
      if (items.length === 0) return;

      spinning = true;

      const winner = pickWinnerIndex();
      const arc = 2 * Math.PI / items.length;
      const mid = winner * arc + arc/2;

      const twoPi = 2 * Math.PI;
      // å³ãƒã‚¤ãƒ³ã‚¿(è§’åº¦0)ã«å½“é¸ã®ä¸­å¿ƒãŒæ¥ã‚‹ã‚ˆã†ã«
      const targetBase = ((-mid % twoPi) + twoPi) % twoPi;
      const currentNorm = ((angle % twoPi) + twoPi) % twoPi;

      let delta = (targetBase - currentNorm + twoPi) % twoPi;
      delta += (5 + Math.floor(Math.random()*3)) * twoPi; // 5ã€œ7å›è»¢

      const startAngle = angle;
      const endAngle = angle + delta;
      const duration = 2600 + Math.random()*700;
      const st = performance.now();

      function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      document.getElementById("result").innerText = "æŠ½é¸ä¸­â€¦";

      function anim(now){
        const p = Math.min(1, (now - st) / duration);
        const e = easeOutCubic(p);
        angle = startAngle + (endAngle - startAngle) * e;
        draw();

        if (p < 1) requestAnimationFrame(anim);
        else {
          spinning = false;
          document.getElementById("result").innerText = "ğŸŠ " + items[winner].name + " ğŸŠ";
        }
      }
      requestAnimationFrame(anim);
    }

    // ã‚¿ãƒƒãƒ—ã§ã‚‚å›ã›ã‚‹
    canvas.addEventListener("click", spin);

    // åˆå›ï¼šä¿å­˜æ¸ˆã¿è¨­å®šã‚’å¾©å…ƒ
    loadItemsText();
  </script>

  <!-- ===== Service Worker ç™»éŒ²ï¼ˆPWAï¼‰===== -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
  <!-- =================================== -->

</body>
</html>
